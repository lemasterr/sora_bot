# Sora Suite — контрольный центр для пайплайна Sora

Sora Suite — это десктопная панель управления на PyQt6. Она закрывает весь рабочий цикл вокруг Sora: автогенерацию промптов, скачивание драфтов, блюр и склейку, публикацию на YouTube и TikTok, обслуживание каталогов и уведомления в Telegram. Интерфейс разделён на вкладки, а цветная панель «Сейчас» и история событий показывают, что делает пайплайн в каждую секунду.

## Обзор возможностей
- Тёмная тема в цветах статистики, настраиваемые сплиттеры и компактные отступы между блоками.
- Панель задач с чекбоксами этапов, линией статистики (RAW, BLURRED, MERGED, YouTube, TikTok) и отдельной карточкой «Сейчас» с таймером шага.
- Менеджер промптов с автообнаружением профилей Chrome, файлами `prompts_<slug>.txt`, списком использованных строк и диспетчером параллельных окон Sora.
- Настройки по разделам (каталоги, Chrome, FFmpeg, YouTube, TikTok, Telegram, обслуживание, встроенный просмотр README) с автосохранением и кнопкой «Применить».
- YouTube и TikTok загрузчики с пакетным расписанием, архивацией, Telegram-уведомлениями и кнопкой запуска GitHub Actions.
- Подсистема обслуживания: автоматическая очистка рабочих папок, отчёты о размерах, проверка окружения и обновление из GitHub.

## Установка
### Быстрый скрипт
```bash
python scripts/bootstrap.py
```
Скрипт создаст виртуальное окружение (если не создано), установит зависимости из `sora_suite/requirements.txt` и скачает Chromium для Playwright (нужен авто‑генератор и downloader).

### Ручная установка
```bash
python -m venv .venv
# Windows: .venv\Scripts\activate
# macOS/Linux: source .venv/bin/activate
pip install -r sora_suite/requirements.txt
python -m playwright install chromium
```

### Системные зависимости
- **FFmpeg** в `PATH` (Windows — сборка с gyan.dev, macOS — `brew install ffmpeg`, Debian/Ubuntu — `sudo apt install ffmpeg`).
- **Playwright** требует библиотеки `libnss3`, `libxss1`, `fonts-liberation` (Ubuntu: `sudo apt install libnss3 libxss1 fonts-liberation`).
- **OpenCV** ставится автоматически через `opencv-python`; дополнительные плагины не нужны.

## Секреты и учётные данные
Создайте папку `sora_suite/secrets/` и храните приватные файлы отдельно от `app_config.yaml`. Рекомендуемая структура:
```
sora_suite/
  secrets/
    youtube/
      channel-a/client_secret.json
    tiktok/
      main_profile.json
    telegram.txt (опционально)
```
Эти файлы выбираются в интерфейсе, а сами значения кэшируются в конфиге только при необходимости.

### YouTube OAuth
1. В Google Cloud Console создайте проект и OAuth‑клиент типа **Desktop app**. Скачайте `client_secret.json` и положите в `sora_suite/secrets/youtube/<имя_канала>/`.
2. Во вкладке *Настройки → YouTube* добавьте канал и укажите путь к `client_secret.json`. При первом запуске авторизации появится окно браузера; полученный `credentials.json` сохранится рядом и подхватится автоматически.
3. Настройте папку с клипами, задержку, лимит и режим «Черновик / Публикация» — значения синхронизируются со вкладкой YouTube.

### TikTok Content Posting API
1. Зарегистрируйтесь на [developers.tiktok.com](https://developers.tiktok.com/), создайте приложение и включите доступ **Content Posting API**.
2. Получите `client_key` и `client_secret`, выполните OAuth (через свой скрипт или Postman) и обменяйте код на `refresh_token` и `open_id` пользователя.
3. Сохраните данные в JSON, например:
   ```json
   {
     "client_key": "aw41...",
     "client_secret": "***",
     "open_id": "1234567890",
     "refresh_token": "rt_...",
     "access_token": "optional",
     "access_token_expires_at": "2024-07-01T10:00:00+00:00"
   }
   ```
   Положите файл в `sora_suite/secrets/tiktok/`.
4. На вкладке TikTok нажмите «…» чтобы выбрать файл и «Загрузить из файла» — поля `client_key`, `client_secret`, `open_id`, `refresh_token` заполнятся автоматически. При запуске загрузки приложение обновит `access_token` и сохранит новые значения в конфиг и JSON.

### Telegram
1. Создайте бота у @BotFather и получите токен.
2. Узнайте `chat_id` (команда `/start`, затем `https://api.telegram.org/botTOKEN/getUpdates`).
3. Заполните раздел *Настройки → Telegram* и нажмите «Отправить тест».

## Запуск и базовый сценарий
1. Активируйте виртуальное окружение (если нужно) и запустите `python sora_suite/app.py`.
2. На вкладке **Задачи** отметьте нужные этапы, нажмите «Старт выбранного» — рядом доступна отдельная кнопка запуска без повторного выбора.
3. Карточка «Сейчас» показывает текущий шаг, цветовое состояние и таймер; история справа/слева сворачивается по чекбоксу, плотность записей переключается между «компакт» и «стандарт».
4. Линия статистики под статусом подсвечивает количество файлов в RAW/BLURRED/MERGED и размер очередей YouTube/TikTok.

## Интерфейс вкладок
### Задачи
- Подвкладка «Пайплайн» содержит чекбоксы шагов, кнопки *Старт выбранного* и *Стоп всё*, полоску прогресса и статистику.
- Подвкладки «Скачка», «Переименование», «Склейка» оформлены в одну колонку без лишних отступов.

### Промпты и параллельные окна
- Слева — список профилей Chrome и активный файл `prompts_<slug>.txt`.
- Сплиттеры позволяют независимо растягивать редактор, историю использованных промптов и таблицу параллельных инстансов.
- Каждый профиль сохраняет логи отправок отдельно; кнопка автосканирования находит каталоги Chrome для Windows/macOS/Linux.

### YouTube
- Слева список каналов с путями к `client_secret.json` и `credentials.json`.
- Вкладка «YouTube» отображает очередь, поддерживает пакетную задержку, переключатель «Черновик», архив и кнопку запуска GitHub Actions.

### TikTok
- Список профилей справа отображает активный профиль и путь к JSON с ключами.
- Поля `client_key`, `client_secret`, `open_id`, `refresh_token` можно редактировать вручную или загружать из файла; подпись сообщает срок действия access token.
- Вкладка «TikTok» повторяет настройки задержки, лимита, папки и черновиков, отображает размер очереди и предоставляет кнопки «Показать очередь», «Запустить загрузку» и «GitHub Actions».

### Настройки
- Вкладки: *Каталоги*, *Chrome*, *FFmpeg*, *YouTube*, *TikTok*, *Telegram*, *Обслуживание*, *Документация*.
- Настройки сохраняются автоматически через несколько секунд после изменения и по кнопке «Применить»; статус отображается под кнопкой.
- Пути к папкам (downloads/blurred/merged, источники YouTube/TikTok и т.д.) нормализуются относительно папки `sora_suite`, поэтому downloader, блюр и другие шаги работают с одними и теми же каталогами рядом с `app_config.yaml`, а не в соседних директориях.
- При запуске приложение автоматически создаёт отсутствующие каталоги (RAW/BLURRED/MERGED, архивы YouTube/TikTok), так что кнопки «Открыть папку» сразу работают даже на чистой установке.

### Обслуживание и документация
- Раздел «Обслуживание» задаёт сроки хранения для RAW/BLURRED/MERGED, запускает ручную очистку и выводит размеры папок.
- Кнопки «Проверить обновления» и «Обновить из GitHub» вызывают `git fetch`/`git pull`.
- Вкладка «Документация» отображает README.md с кнопкой «Обновить» и отчётом в истории событий.

## Параметры FFmpeg
| Ключ | Что делает | Где менять | Комментарий |
|------|-------------|------------|-------------|
| `binary` | Путь к FFmpeg | Настройки → FFmpeg | Укажите абсолютный путь, если FFmpeg не в `PATH`. |
| `vcodec` | Видеокодек (`libx264`, `auto_hw`, `copy`) | Настройки → FFmpeg | `auto_hw` выбирает доступный аппаратный кодек; при блюре `copy` автоматически заменяется на `libx264`. |
| `crf` | Качество `libx264` (0–51) | Настройки → FFmpeg | 18–20 для TikTok/YouTube; меньше — лучше качество, больше — меньший размер. |
| `preset` | Скорость кодирования `libx264` | Настройки → FFmpeg | `veryfast` — компромисс, `slow` — лучше качество, но дольше. |
| `format` | Контейнер (`mp4`, `mov`, `webm`) | Настройки → FFmpeg | TikTok/YouTube предпочитают `mp4`. |
| `copy_audio` | Копировать аудио без перекодирования | Настройки → FFmpeg | При несовместимом исходнике приложение предложит перекодировать в AAC. |
| `blur_threads` | Количество параллельных FFmpeg | Настройки → FFmpeg | Учитывайте число ядер/ГПУ, чтобы не перегрузить систему. |
| `post_chain` | Дополнительные фильтры | Настройки → FFmpeg | `noise`, `unsharp` и др. выполняются после масок блюра. |
| `presets.*.zones` | Прямоугольники блюра | Настройки → FFmpeg | Таблица с предпросмотром на OpenCV показывает маску поверх видео. |

## Автопостинг и GitHub Actions
### YouTube
1. Добавьте канал в настройках и укажите папку с готовыми клипами.
2. Во вкладке YouTube настройте черновик/расписание, интервал и лимит. Время публикации синхронизируется между вкладками.
3. По завершении загрузки файл переносится в `uploaded/`, а статус появляется в истории и, при включённом Telegram, в чате.

### TikTok API
1. Создайте профиль, загрузите JSON с ключами или заполните поля вручную. Access token обновится автоматически перед загрузкой; статус и срок действия отображаются в подсказке.
2. Укажите папку с роликами, включите расписание (плановые публикации переводятся в UTC) или черновики.
3. После успешной загрузки файлы перемещаются в `uploaded_tiktok/`, метаданные переносятся вместе с видео.
4. Telegram уведомления сообщают о старте/завершении, ошибках API и перемещении в архив.

### GitHub Actions
- В `.github/workflows/tiktok-upload.yml` готов шаблон. Он ожидает секреты `TIKTOK_CLIENT_KEY`, `TIKTOK_CLIENT_SECRET`, `TIKTOK_REFRESH_TOKEN`, `TIKTOK_OPEN_ID` и параметры `profile`, `src_dir`, `limit`, `interval`, `publish_at`, `draft`.
- Workflow устанавливает зависимости через `scripts/bootstrap.py` и запускает `sora_suite/workers/tiktok/upload_queue.py` с теми же параметрами, что и локальный запуск.
- Кнопка «GitHub Actions» на вкладке TikTok вызывает `gh workflow run` с выбранными полями.

## Telegram уведомления
- Переключатель в настройках включает/выключает бота. Если уведомления выключены, приложение показывает одно предупреждение в истории.
- Отправляются события запуска сценария, завершения шагов (download/blur/merge/upload), ручных сохранений, обслуживания, проверки окружения и GitHub обновлений.

## Обслуживание и обновления
- Автоочистка срабатывает при запуске, если включён флаг «Чистить при старте».
- «Размеры папок» сообщает объём RAW/BLURRED/MERGED/архивов в истории событий.
- Кнопка «Проверка окружения» проверяет FFmpeg, бинарник Chrome, наличие профилей, валидность Telegram и YouTube/TikTok конфигурации.
- `scripts/self_update.py` выполняет ту же логику обновления из консоли (fetch/pull).

## Сборка standalone-версий
### Windows (EXE через PyInstaller)
```bash
python -m pip install pyinstaller
pyinstaller --noconfirm --clean --windowed \
  --name "SoraSuite" \
  --add-data "sora_suite/app_config.yaml;sora_suite" \
  sora_suite/app.py
```
Полученный `dist/SoraSuite/SoraSuite.exe` можно упаковать в архив или в инсталлятор.

### macOS (DMG)
```bash
python -m pip install pyinstaller create-dmg
pyinstaller --noconfirm --clean --windowed \
  --name "SoraSuite" \
  --add-data "sora_suite/app_config.yaml:sora_suite" \
  sora_suite/app.py

create-dmg \
  --overwrite \
  --volname "Sora Suite" \
  --app-drop-link 400 200 \
  "SoraSuite.dmg" \
  "dist/SoraSuite.app"
```
Для распространения подпишите и нотарифицируйте приложение (macOS 11+).

## Параллельные окна Sora
1. Нажмите «Автонайти» — приложение просканирует стандартные директории профилей Chrome (Windows/macOS/Linux) и создаст заготовки `prompts_<slug>.txt`.
2. Для каждого окна задайте уникальный порт (9222, 9223, …) и при необходимости `user_data_dir`.
3. Журналы `submitted_<имя>.log` ведутся для каждого окна; список использованных промптов можно растягивать сплиттером.
4. Кнопка «Параллельный автоген» запускает Playwright для всех выбранных окон, прогресс отображается в карточке «Сейчас» и в Telegram.

## Полезные заметки
- Лента событий имеет два режима плотности и полностью скрывается, оставляя только карточку «Сейчас».
- Прозрачные чекбоксы теперь окрашиваются в синий цвет при включении, что хорошо видно на тёмной теме.
- Сплиттеры позволяют гибко настраивать ширину истории, карточки «Сейчас», редактора промптов и списка профилей.
- `scripts/bootstrap.py` удобно запускать после обновлений репозитория или на CI — он гарантирует актуальность Playwright и Python-зависимостей.
- GitHub workflow `tiktok-upload.yml` теперь работает без cookies, достаточно задать API-ключи через секреты.
- Sora Suite легко расширить: добавляйте новые воркеры в `sora_suite/workers/` и подключайте их в разделе «Задачи».
