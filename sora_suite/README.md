# Sora Suite — настольный комбайн для пайплайна Sora

Sora Suite управляет всем циклом подготовки роликов: сбор промптов, пакетная генерация
изображений через Google AI Studio, скачивание и блюр исходников, склейка,
загрузка на YouTube и TikTok, ведение истории, телеграм‑уведомления и сервисные
операции. Интерфейс собран на PyQt6 и работает одинаково на Windows, macOS и Linux.

## Содержание
- [Что делает приложение](#что-делает-приложение)
- [Установка и обновление](#установка-и-обновление)
- [Запуск](#запуск)
- [Chrome через DevTools Protocol](#chrome-через-devtools-protocol)
- [Навигация по интерфейсу](#навигация-по-интерфейсу)
  - [Левая панель](#левая-панель)
  - [Обзор](#обзор)
  - [Контент](#контент)
  - [Автопостинг](#автопостинг)
  - [Настройки](#настройки)
- [Генерация картинок Google AI Studio](#генерация-картинок-google-ai-studio)
- [Пайплайн и сценарии](#пайплайн-и-сценарии)
- [Телеграм-уведомления](#телеграм-уведомления)
- [История и статистика](#история-и-статистика)
- [FFmpeg — параметры и советы](#ffmpeg--параметры-и-советы)
- [Оптимизация и частые вопросы](#оптимизация-и-частые-вопросы)

## Что делает приложение
- Подхватывает текстовые промпты и промпты для изображений по профилям Chrome.
- Запускает пакетную генерацию картинок по очереди промптов и ведёт манифест
  (`generated_images/manifest.json`) для повторного использования.
- Публикует промпты в Sora, при необходимости прикрепляя подготовленные изображения.
- Обрабатывает скачанные ролики: переименование, блюр с масками, склейка.
- Готовит отложенные публикации на YouTube и TikTok, отображает очереди, даёт быстрый
  доступ к рабочим каталогам.
- Рассылает телеграм‑уведомления о шагах сценария и результатах.
- Показывает историю событий, статистику по каталогам, результаты тестов окружения.

## Установка и обновление
### Быстрый старт
```bash
python scripts/bootstrap.py
```
Скрипт создаст виртуальное окружение, установит зависимости из
`sora_suite/requirements.txt` и скачает Chromium для Playwright.

### Ручная установка
```bash
python -m venv .venv
# Windows: .venv\Scripts\activate
# macOS/Linux: source .venv/bin/activate
pip install -r sora_suite/requirements.txt
python -m playwright install chromium
```

### Системные зависимости
- **FFmpeg** в `PATH` (`brew install ffmpeg`, `sudo apt install ffmpeg`, или официальный
  билд для Windows).
- **Playwright** требует `libnss3`, `libxss1`, `fonts-liberation` на Linux
  (`sudo apt install libnss3 libxss1 fonts-liberation`).
- **Qt** ставится вместе с PyQt6, дополнительных пакетов не нужно.

Для обновления зависимостей перезапустите `pip install -r sora_suite/requirements.txt`.
Служебные кнопки «Проверить обновления» и «Обновить из GitHub» доступны на вкладке
«Настройки → Обслуживание».

## Запуск
Запускаем интерфейс из корня репозитория:
```bash
python sora_suite/app.py
```
При первом старте приложение создаст рабочие каталоги рядом с `app.py`, если их
ещё нет, и предложит указать ключевые пути в настройках.

## Chrome через DevTools Protocol
Автоген и загрузчики подключаются к уже запущенному браузеру через CDP. Браузер
нужно запускать с параметром `--remote-debugging-port` и указать тот же порт в
«Настройки → Chrome → Chrome CDP порт».

Любой свободный порт из диапазона 1024–65535 подходит. Примеры:

macOS:
```bash
/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome \
  --remote-debugging-port=9222 \
  --user-data-dir=/tmp/chrome-sora
```

Windows PowerShell:
```powershell
"C:\Program Files\Google\Chrome\Application\chrome.exe" `
  --remote-debugging-port=9222 `
  --user-data-dir=%TEMP%\chrome-sora
```

Linux:
```bash
/opt/google/chrome/google-chrome \
  --remote-debugging-port=9222 \
  --user-data-dir=/tmp/chrome-sora
```

Проверьте `http://localhost:<порт>/json/version` — в ответ должен прийти JSON с
`webSocketDebuggerUrl`. Если порт уже занят, выберите другой и обновите значение
в настройках.

## Навигация по интерфейсу
### Верхняя панель
Под баннером отображается компактная панель:
- выбор профиля Chrome и кнопка «Запустить Chrome»;
- блок «Каталоги» с иконками быстрого открытия: проект, RAW, BLURRED, MERGED,
  `generated_images`;
- кнопки «Старт выбранного» и «Стоп все» для запуска сценария и остановки текущих задач.

### Левая панель
Содержит карточку текущего события и расширенную историю с фильтром, иконками
состояний и экспортом в файл. Плотность списка можно переключить в настройках интерфейса.

### Обзор
Секция разделена на подпункты:
- **Сценарии** — основной пульт запуска. Здесь отмечаются этапы пайплайна,
  доступна статистика по каталогам, кнопки открытия папок и быстрый старт генерации
  картинок.
- **История** — журнал событий и действий сценария с кнопкой «Обновить» и
  экспортом.
- **Ошибки** — справочник типичных проблем и способов их устранения.

### Контент
- **Промпты Sora** — профили с индивидуальными файлами `prompts_*.txt`, редактор
  текста, история использованных строк, управление несколькими окнами Chrome.
- **Промпты картинок** — отдельный редактор `image_prompts.txt`. Поддерживает
  строки JSON с полями `prompt`, `prompts`, `count`, `video_prompt`. Можно хранить
  хоть 10 промптов подряд — воркер выполнит их по очереди.
- **Названия** — менеджер `titles.txt` с сохранением и сбросом курсора.

### Автопостинг
- **YouTube** — список каналов, загрузка `client_secret.json` и `credentials.json`,
  настройка приватности, очереди, интервалов и папки загрузки (кнопки выбора и
  открытия находятся рядом).
- **TikTok** — профили API, расписание, GitHub Actions, шаблоны подписей. Папку
  загрузки также можно открыть напрямую.

### Настройки
Вкладки отсортированы по частоте использования:
1. **Каталоги** — все рабочие пути (RAW, BLURRED, MERGED, источники блюра и
   склейки, `generated_images`, `history.jsonl`, `titles.txt`) с кнопками выбора и
   открытия. Папка изображений синхронизируется с настройкой Google AI.
2. **Генерация картинок** — параметры Google AI Studio: API‑ключ, модель,
   размер кадра, количество изображений на промпт, лимиты, директория вывода,
   флаг прикрепления к заявке Sora.
3. **Автоген** — интервалы пауз для воркера `workers/autogen`.
4. **YouTube** и **TikTok** — значения по умолчанию для расписания и источников.
5. **Telegram** — токен, ID чата и тестовое уведомление.
6. **Chrome** — порт CDP, путь к бинарю, список профилей.
7. **FFmpeg** — глобальные параметры кодирования и таблица пресетов блюра.
8. **Интерфейс** — переключение плотности истории и отображения левой панели.
9. **Обслуживание** — лимиты хранения, тест окружения, обновления из GitHub,
   ручная очистка и оценка размеров папок.
10. **Документация** — встроенный просмотр этого README.

## Генерация картинок Google AI Studio
1. Настройте вкладку «Генерация картинок»: ключ, модель, количество изображений,
   размер, MIME-тип, директорию вывода.
2. Отредактируйте список промптов на странице «Контент → Промпты картинок».
   Пустые строки и комментарии `#` игнорируются. JSON-строки позволяют задать
   несколько кадров (`count`) и текст `video_prompt`, который позже пойдёт в Sora.
3. Нажмите «Генерация картинок (Google)» в разделе «Сценарии» для автономного
   запуска. Воркер выполнит промпты по очереди (хоть 10 подряд), переименует
   результаты последовательно (`0001.jpg`, `0002.jpg`, …) и добавит их в манифест.
4. После проверки изображений можно запустить сценарий с галочкой
   «Генерация картинок (Google)», чтобы повторить пакетное создание прямо в цепочке,
   или отключить галочку и использовать уже готовые файлы.
5. Флаг «Прикреплять изображения» в настройках управляет тем, будут ли файлы
   автоматически загружены в интерфейс Sora при вставке промптов.

## Пайплайн и сценарии
Вкладка «Сценарии» содержит чекбоксы шагов:
1. **Генерация картинок (Google)** — батч Google AI Studio.
2. **Вставка промптов в Sora** — автоматический воркер, который берёт текстовые
   промпты, прикрепляет изображения (если разрешено) и запускает генерацию видео.
3. **Авто-скачка видео** — загрузка готовых клипов.
4. **Блюр водяного знака** — применение масок и пост-обработки FFmpeg.
5. **Склейка группами N** — объединение клипов после блюра.
6. **Загрузка на YouTube** — отложенный постинг по расписанию.
7. **Загрузка в TikTok** — пакетная отправка с расписанием и GitHub Actions.

Можно запускать любой поднабор шагов; цепочка выполняется в отмеченном порядке.
Статус отображается в левой карточке, а завершение дублируется в Telegram
(если включено).

Отдельные кнопки позволяют запустить только генерацию изображений или открыть
папку с результатами. Папки из верхнего блока помогают быстро перейти к RAW,
BLURRED, MERGED и `generated_images`.

## Телеграм-уведомления
Раздел «Настройки → Telegram» включает переключатель, токен бота и chat id.
Нажмите «Отправить тест», чтобы убедиться в корректности настроек. В процессе
сценария отправляются уведомления о старте, завершении и ошибках шагов.

## История и статистика
- Карточка «Сейчас» показывает активный шаг и таймер.
- Журнал событий содержит фильтр по тексту или тегам, переключение плотности
  элементов, экспорт в текстовый файл.
- Статистика обновляется на лету и кешируется — карточки RAW, BLURRED, MERGED,
  очередей YouTube/TikTok и **IMAGES** (количество файлов + размер каталога).

## FFmpeg — параметры и советы
| Параметр | Значение по умолчанию | Где менять | Назначение | Советы |
| --- | --- | --- | --- | --- |
| `binary` | `ffmpeg` | Настройки → FFmpeg | Путь к бинарю FFmpeg | Укажите полный путь, если бинарь вне `PATH`.
| `vcodec` | `auto_hw` | Настройки → FFmpeg | Выбор видеокодека | `auto_hw` ищет аппаратный кодек; при отсутствии падает на `libx264`.
| `crf` | `18` | Настройки → FFmpeg | Качество `libx264` (0–51) | 18–20 — баланс размера и качества; выше значение → меньше размер.
| `preset` | `veryfast` | Настройки → FFmpeg | Скорость кодирования | Медленнее preset = лучше качество, но нагрузка больше.
| `format` | `mp4` | Настройки → FFmpeg | Контейнер итоговых файлов | Совместим с TikTok и YouTube.
| `copy_audio` | `True` | Настройки → FFmpeg | Перекодирование аудио | При несовместимом формате приложение предложит перекодировать в AAC.
| `blur_threads` | `2` | Настройки → FFmpeg | Параллельные процессы блюра | Подберите под количество ядер. Значение >4 имеет смысл только на мощных ПК.
| `post_chain` | `boxblur=1:1,noise=alls=2:allf=t,unsharp=3:3:0.5:3:3:0.0` | Настройки → FFmpeg | Дополнительные фильтры | Можно удалить или заменить, если нужен чистый экспорт.
| `presets.*.zones` | см. таблицу в UI | Настройки → FFmpeg | Координаты масок | Дважды щёлкните по значению, чтобы отредактировать зоны прямо в таблице.

## Оптимизация и частые вопросы
- **Приложение долго стартует?** README и тяжёлые данные загружаются лениво,
  статистика кешируется, а настройки автоматически сохраняются при изменении.
- **Можно запустить только генерацию картинок?** Да, кнопка и чекбокс позволяют
  выполнить батч изображений без обращения к Sora.
- **Как работать с несколькими промптами Google AI?** Добавьте их построчно в
  редактор «Промпты картинок» — воркер выполнит их последовательно, создаст
  манифест и переименует файлы в порядке очереди.
- **Где искать каталоги?** Все пути перечислены во вкладке «Каталоги» и
  доступны с верхней панели. Кнопка `↗` открывает выбранную папку в проводнике,
  `…` позволяет быстро переназначить путь.
- **Как остановить шаг?** Нажмите «Стоп все» — активные воркеры получат сигнал
  и закроются, а история добавит запись о прерывании.
- **Почему автоген не подключается к Chrome?** Проверьте порт CDP и убедитесь,
  что `http://localhost:<порт>/json/version` возвращает JSON. Если нет — запустите
  Chrome с другим портом и обновите значение в настройках.

Если нужны дополнительные автоматизации или интеграции — создайте issue или
pull-request в репозитории `sora_bot`.
