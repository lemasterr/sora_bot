# Sora Suite — настольный комбайн для пайплайна Sora

Sora Suite управляет всем циклом подготовки роликов: генерация изображений через Google AI Studio, отправка промптов в Sora, скачивание, блюр, склейка, автопостинг на YouTube и TikTok, уведомления в Telegram и сервисные операции. Приложение работает на Windows, macOS и Linux, интерфейс написан на PyQt6.

## Содержание
- [Что делает приложение](#что-делает-приложение)
- [Установка и обновление](#установка-и-обновление)
- [Запуск](#запуск)
- [Chrome через DevTools Protocol](#chrome-через-devtools-protocol)
- [Навигация по интерфейсу](#навигация-по-интерфейсу)
  - [Верхняя панель](#верхняя-панель)
  - [Обзор](#обзор)
  - [Контент](#контент)
  - [Автопостинг](#автопостинг)
  - [Настройки](#настройки)
- [Промпты и названия](#промпты-и-названия)
- [Генерация картинок Google AI Studio](#генерация-картинок-google-ai-studio)
  - [Настройка API и моделей](#настройка-api-и-моделей)
  - [Работа с image-prompts](#работа-с-image-prompts)
- [Пайплайн и сценарии](#пайплайн-и-сценарии)
- [Автопостинг YouTube](#автопостинг-youtube)
- [Автопостинг TikTok](#автопостинг-tiktok)
- [Телеграм-уведомления](#телеграм-уведомления)
- [История и статистика](#история-и-статистика)
- [FFmpeg — параметры и советы](#ffmpeg--параметры-и-советы)
- [Оптимизация и частые вопросы](#оптимизация-и-частые-вопросы)

## Что делает приложение
- Подхватывает текстовые промпты и image-промпты по профилям Chrome.
- Запускает пакетную генерацию изображений, ведёт manifest и переименовывает картинки последовательно.
- Отправляет промпты в Sora, автоматически прикладывая проверенные изображения и video_prompt.
- Скачивает сгенерированные ролики, переименовывает, блюрит, склеивает и готовит к публикации.
- Управляет очередями YouTube и TikTok с отложенным постингом и хранением учётных данных.
- Отправляет уведомления в Telegram и ведёт подробную историю действий.

## Установка и обновление
### Быстрый старт
```bash
python scripts/bootstrap.py
```
Скрипт создаст виртуальное окружение, установит зависимости из `sora_suite/requirements.txt` и скачает Chromium для Playwright.

### Ручная установка
```bash
python -m venv .venv
# Windows: .venv\Scripts\activate
# macOS/Linux: source .venv/bin/activate
python -m pip install --upgrade pip
pip install -r sora_suite/requirements.txt
python -m playwright install chromium
```

### Системные зависимости
- **FFmpeg** в `PATH` (`brew install ffmpeg`, `sudo apt install ffmpeg` или официальный билд для Windows).
- **Playwright** требует `libnss3`, `libxss1`, `fonts-liberation` на Linux.
- **Qt** ставится вместе с PyQt6.

Повторный запуск `pip install -r sora_suite/requirements.txt` обновит зависимости.

## Запуск
```bash
python sora_suite/app.py
```
При первом старте приложение создаст рабочие каталоги рядом с `app.py`. Все пути можно поменять на вкладке **Настройки → Каталоги**.

## Chrome через DevTools Protocol
Автоген и загрузчики подключаются к запущенному Chrome/Chromium через CDP. Запускайте браузер с параметром `--remote-debugging-port` и укажите тот же порт в настройках.

Любой свободный порт 1024–65535 подойдёт. Примеры:

macOS:
```bash
/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome \
  --remote-debugging-port=9222 \
  --user-data-dir=/tmp/chrome-sora
```

Windows PowerShell:
```powershell
"C:\Program Files\Google\Chrome\Application\chrome.exe" `
  --remote-debugging-port=9222 `
  --user-data-dir=%TEMP%\chrome-sora
```

Linux:
```bash
/opt/google/chrome/google-chrome \
  --remote-debugging-port=9222 \
  --user-data-dir=/tmp/chrome-sora
```

Проверьте `http://localhost:<порт>/json/version` — ответ должен содержать `webSocketDebuggerUrl`. В верхней панели есть кнопка автодетекта профилей и запускателя Chrome: выбирайте профиль, нажимайте «⟳» для поиска в системе и «Запустить Chrome» для быстрого старта.

## Навигация по интерфейсу
### Верхняя панель
Компактный блок под баннером содержит:
- выбор профиля Chrome и кнопку запуска браузера;
- кнопку «⟳» для автопоиска профилей в файловой системе;
- компактные кнопки быстрого открытия каталогов (проект, RAW, BLURRED, MERGED, generated_images);
- кнопки «Старт выбранного» и «Стоп все» для сценария.

### Обзор
Отображает вкладку «Пайплайн» с чекбоксами этапов, кнопками запуска, общей статистикой и ссылками на папки. История и справочник ошибок переехали в настройки, чтобы основная страница оставалась лаконичной.

### Контент
- **Промпты Sora** — редактор текстовых промптов. Для каждого профиля Chrome хранится свой `prompts_<profile>.txt`. История использованных строк отображается ниже.
- **Промпты картинок** — отдельный `image_prompts.txt` с поддержкой JSON-строк (`prompt`, `prompts`, `count`, `video_prompt`). Все строки обрабатываются по порядку, можно задать десяток и более.
- **Названия** — менеджер `titles.txt`: используются при переименовании скачанных роликов. Кнопка сбрасывает курсор, если список уже исчерпан.

### Автопостинг
Две страницы — YouTube и TikTok. Здесь управляются очереди, расписания, учётные данные и папки загрузки. Для каждой платформы добавлены подсказки со ссылками, как получить необходимые файлы.

### Настройки
Вкладки отсортированы по частоте использования:
1. **Каталоги** — все рабочие пути (RAW, BLURRED, MERGED, источники блюра, `generated_images`, история, titles). Подсказка напоминает, где искать подробное описание.
2. **Генерация картинок** — параметры Google AI Studio: API-ключ, модель, лимиты, директория, прикрепление к заявкам.
3. **Автоген** — паузы и параллельность воркера.
4. **FFmpeg** — глобальные кодеки, блюр-пресеты и предпросмотр.
5. **Chrome** — порт CDP, бинарь, user-data-dir, управление профилями и их автодетект.
6. **YouTube** — каналы, OAuth-файлы, расписание и папка загрузок.
7. **TikTok** — профили API, шаблоны подписей, расписания.
8. **Telegram** — токен, chat id, тестовое уведомление.
9. **Интерфейс** — плотность истории и отображение левой панели.
10. **История** — просмотр `history.jsonl` прямо из настроек.
11. **Ошибки** — таблица типовых проблем и решений.
12. **Обслуживание** — тест окружения, лимиты хранения, обновления из GitHub.
13. **Документация** — встроенный просмотр этого README.

## Промпты и названия
- **Профили**. Каждый профиль Chrome ведёт собственные `prompts_<profile>.txt` и `image_prompts_<profile>.txt`. Переключатель в левом списке сразу делает профиль активным для сценария.
- **Image prompts**. JSON-строки позволяют указать массив `prompts`, поле `count` и `video_prompt`. Пример:
  ```json
  {"prompt": "dramatic sunset city", "count": 2, "video_prompt": "Закат переливается в таймлапсе"}
  ```
- **Названия**. Вкладка «Названия» управляет `titles.txt`. Список используется при переименовании скачанных клипов (режим «по списку») и синхронизируется с инструментом переименования в разделе задач.

## Генерация картинок Google AI Studio
### Настройка API и моделей
1. Получите ключ на [Google AI Studio](https://aistudio.google.com/). Сохраните его в настройках.
2. Модели:
   - `models/imagen-4.0-generate-001` — качественная, но дорогая по квотам.
   - `models/imagen-3.0-generate-001` — быстрее, но уступает по детализации.
   - `models/imagen-3.0-lightning` — минимальная задержка, но повышенный риск артефактов.
   Меняя модель, учитывайте политику персон (некоторые варианты не поддерживают `personGeneration`) и квоты проекта.
3. Поле «Генерация людей» оставьте пустым, чтобы SDK сам подстраивался. Устаревшие значения (`ALLOW_ALL`, `BLOCK_ALL`) используются только при необходимости и могут вызывать ошибки 400.
4. Выберите директорию вывода — по умолчанию `generated_images`. Файлы нумеруются `0001.jpg`, `0002.jpg` и т.д., чтобы порядок сохранялся.
5. При необходимости настройте лимит запросов в минуту и количество повторов при ошибке.

### Работа с image-prompts
1. Отредактируйте `image_prompts.txt` на странице «Контент → Промпты картинок».
2. Кнопка **«Генерация картинок (Google)»** на панели сценария или отдельная галочка «Генерация картинок (Google)» запускают пакет. При активном флаге сценарий сначала вызывает Google AI Studio, сохраняет результат в `manifest.json`, затем продолжает шаги.
3. Изображения можно просмотреть в папке `generated_images` (кнопка на верхней панели). Убедитесь, что они подходят, и только после этого запускайте видео-автоген.
4. Переключатель «Прикреплять изображения» в настройках позволяет временно отключить загрузку в Sora, если нужны чисто текстовые заявки.

## Пайплайн и сценарии
Чекбоксы на вкладке «Пайплайн» позволяют собирать нужные этапы в цепочку:
1. **Генерация картинок (Google)** — автономный батч Google AI Studio.
2. **Вставка промптов в Sora** — открывает браузер, прикрепляет изображения (если включено) и запускает генерацию видео.
3. **Авто-скачка видео** — подтягивает готовые клипы.
4. **Блюр водяного знака** — применяет выбранный пресет FFmpeg.
5. **Склейка группами N** — объединяет клипы после блюра.
6. **Загрузка на YouTube** и **TikTok** — отложенные публикации.

Рекомендации:
- Всегда просматривайте картинки в `generated_images` перед запуском видео. Убедитесь, что кадры соответствуют ожиданиям.
- Перед блюром проверьте расположение водяных знаков: на разных видео зона может смещаться, скорректируйте пресеты или добавьте новую зону.
- После блюра и склейки откройте предпросмотр FFmpeg, чтобы оценить результат.

## Автопостинг YouTube
1. Создайте OAuth-клиент в [Google Cloud Console](https://console.cloud.google.com/apis/credentials) (тип «Desktop app»). Скачайте `client_secret.json`.
2. На вкладке **Автопостинг → YouTube** добавьте канал, укажите `client_secret.json` и папку для `credentials.json`. При первом запуске откроется браузер для авторизации — файл с токенами сохранится автоматически.
3. Настройте приватность по умолчанию, расписание (дата старта + интервал в минутах) и лимит клипов за один прогон.
4. Папку для загрузок можно открыть кнопкой `↗`. Очередь обновляется по кнопке «Показать очередь», статус выводится в правой части формы.

## Автопостинг TikTok
1. Зарегистрируйтесь на [TikTok for Developers](https://developers.tiktok.com/), создайте приложение и получите `client_key`/`client_secret`.
2. В кабинете получите `open_id` и `refresh_token` (через авторизацию). Их удобно хранить в отдельном JSON/YAML — приложение загрузит файл кнопкой «Загрузить из файла».
3. На вкладке **Автопостинг → TikTok** заполните поля профиля, укажите часовой пояс, сдвиг расписания, шаблон подписи и хэштеги. Папку с клипами можно открыть прямо из формы.
4. Расписание может запускаться локально (кнопка «Запустить») или через GitHub Actions, если настроено в проекте.

## Телеграм-уведомления
1. Создайте бота через [@BotFather](https://t.me/BotFather), сохраните токен.
2. Напишите боту любое сообщение, зайдите на `https://api.telegram.org/bot<ТОКЕН>/getUpdates` и найдите `chat.id`.
3. В настройках **Telegram** укажите токен, chat id и нажмите «Отправить тест». Приложение будет уведомлять о старте/конце этапов и ошибках.

## История и статистика
- Карточка «Сейчас» показывает активный шаг и таймер. Текст подсвечен на прозрачном фоне, чтобы не отвлекать от остального интерфейса.
- Журнал событий доступен в настройках (вкладка «История»): фильтруй, экспортируй, очищай.
- Статистика на панели сценария отображает количество файлов в RAW/BLURRED/MERGED, очереди YouTube/TikTok и число изображений.

## FFmpeg — параметры и советы
| Параметр | Значение по умолчанию | Где менять | Назначение | Советы |
| --- | --- | --- | --- | --- |
| `binary` | `ffmpeg` | Настройки → FFmpeg | Путь к бинарю | Укажи абсолютный путь, если ffmpeg вне `PATH`. |
| `vcodec` | `auto_hw` | Настройки → FFmpeg | Выбор видеокодека | `auto_hw` ищет аппаратный кодек и откатывается на `libx264`. |
| `crf` | `18` | Настройки → FFmpeg | Качество `libx264` (0–51) | 18–20 — баланс размера и качества. |
| `preset` | `veryfast` | Настройки → FFmpeg | Скорость кодирования | Медленнее preset = лучше качество, но больше нагрузка. |
| `format` | `mp4` | Настройки → FFmpeg | Контейнер итоговых файлов | Совместим с TikTok и YouTube. |
| `copy_audio` | `True` | Настройки → FFmpeg | Перекодирование аудио | При проблемах с кодеком приложение предложит перекодировать в AAC. |
| `blur_threads` | `2` | Настройки → FFmpeg | Параллельные процессы блюра | Подбирай под количество ядер. |
| `post_chain` | `boxblur=1:1,noise=alls=2:allf=t,unsharp=3:3:0.5:3:3:0.0` | Настройки → FFmpeg | Дополнительные фильтры | Можно выключить для чистого экспорта. |
| `presets.*.zones` | см. таблицу в UI | Настройки → FFmpeg | Координаты масок | Дважды щёлкни по ячейке, чтобы изменить X/Y/W/H. |

На вкладке FFmpeg есть кнопка предпросмотра: выбери пресет и убедись, что зона блюра перекрывает водяной знак.

## Оптимизация и частые вопросы
- **Приложение долго стартует?** README и тяжёлые данные подгружаются лениво, статистика кешируется, настройки сохраняются автоматически.
- **Можно запустить только генерацию картинок?** Да: отдельная кнопка и чекбокс сценария выполняют только шаг Google AI Studio.
- **Как работает автодетект профилей?** Верхняя панель ищет папки Chrome/Chromium в стандартных директориях и добавляет их в настройки одним кликом.
- **Где искать каталоги?** Все пути перечислены во вкладке «Каталоги» и доступны через кнопки в верхней панели.
- **Почему автоген не подключается к Chrome?** Проверьте порт CDP и убедитесь, что `http://localhost:<порт>/json/version` возвращает JSON. Если нет — запустите Chrome с другим портом и обновите значение в настройках.
- **Можно ли сменить модель Google AI на лету?** Да, но помните о квотах и политике: lightning-модели дают больше шума, а блокировка генерации людей может срабатывать жёстче. Всегда проверяйте manifest перед отправкой промптов в Sora.

Если нужны дополнительные автоматизации или интеграции — создайте issue или pull-request в репозитории `sora_bot`.
