# Sora Suite — контрольный центр для пайплайна Sora

Sora Suite — это десктопная панель управления на PyQt6, которая объединяет все ежедневные задачи вокруг Sora: автоподачу промптов, скачивание драфтов, блюр и склейку, публикацию на YouTube и TikTok, сопровождение каталогов и уведомления в Telegram. Интерфейс поделен на отдельные вкладки, а лента событий показывает, что происходит прямо сейчас.

## 1. Что входит в комплект

- **Панель задач** с чекбоксами этапов, линией статистики (RAW, BLURRED, MERGED, YouTube, TikTok) и карточкой «Сейчас».
- **Менеджер промптов**: список профилей Chrome, автоматические файлы `prompts_<slug>.txt`, таблица использованных строк и управление параллельными окнами Sora.
- **Настройки**: каталоги, Chrome, FFmpeg, TikTok/YouTube, Telegram, обслуживание и встроенный просмотр README.
- **YouTube uploader** с пакетным расписанием, архивом, поддержкой нескольких каналов и уведомлениями.
- **TikTok uploader** на Playwright/OpenCV, работающий локально или через GitHub Actions, с профилями по cookies, шаблонами подписей и пакетным расписанием.
- **Telegram уведомления**, сервисные проверки окружения, отчёты о размерах папок и автоматическая очистка.

## 2. Установка

### Быстрый скрипт

```bash
python scripts/bootstrap.py
```

Скрипт установит Python-зависимости и скачает браузер Chromium для Playwright.

### Ручная установка

```bash
python -m venv .venv
# Windows: .venv\Scripts\activate
# macOS/Linux: source .venv/bin/activate
pip install -r sora_suite/requirements.txt
python -m playwright install chromium
```

FFmpeg должен находиться в `PATH`:
- Windows: скачайте сборку с [gyan.dev](https://www.gyan.dev/ffmpeg/builds/)
- macOS: `brew install ffmpeg`
- Debian/Ubuntu: `sudo apt install ffmpeg`

Playwright требует системные библиотеки: `libnss3`, `libxss1`, `fonts-liberation` (Ubuntu: `sudo apt install libnss3 libxss1 fonts-liberation`).

## 3. Быстрый старт

1. Запустите приложение: `python sora_suite/app.py`.
2. Во вкладке «Задачи» отметьте нужные этапы и нажмите «Старт выбранного».
3. Лента событий в левой колонке показывает текущую операцию, её длительность и историю. Карточку можно свернуть, история перестаёт занимать место, если отключить флажок «Показывать».
4. Счётчики статистики:
   - **RAW** — файлы в папке скачивания;
   - **BLURRED** — клипы, ожидающие блюра;
   - **MERGED** — готовые склейки;
   - **YouTube** — файлы, попадущие в очередь загрузчика;
   - **TikTok** — аналогичный счётчик для TikTok.

## 4. Основные вкладки

### Задачи
- Подвкладка «Пайплайн» — чекбоксы шагов, кнопка запуска и строка статистики.
- «Скачка», «Переименование», «Склейка» — компактные формы без лишних отступов.
- История событий регулируется переключателем плотности (компакт/стандарт) и полностью сворачивается.

### Промпты и параллельные окна
- Список профилей Chrome и активный файл промптов отображаются слева.
- Сплиттеры позволяют независимо растягивать редактор, таблицу использованных промптов и менеджер инстансов.
- Для каждого профиля создаётся собственный `prompts_<slug>.txt`; журналы отправок (`submitted_<имя>.log`) сохраняются по отдельности, что упрощает восстановление после ошибок.
- Блок «Окна Sora» содержит автообнаружение профилей (Windows, macOS, Linux), настройку портов и тумблер включения в параллельный запуск.

### Настройки
- **Каталоги**: поля выровнены в столбик, источники блюра/склейки синхронизируются с основными папками.
- **Chrome**: бинарник, порт CDP, список профилей.
- **FFmpeg**: параметры кодека, таблица зон, предпросмотр на OpenCV.
- **YouTube / TikTok**: дефолтные задержки, лимиты, архивы и workflow для GitHub Actions.
- **Telegram**: переключатель, токен, chat id, тест отправки.
- **Обслуживание**: сроки хранения, отчёт о размерах, очистка, проверка окружения и кнопки «Проверить обновления» / «Обновить из GitHub».
- **Документация**: встроенный просмотр README с кнопкой «Обновить».

## 5. Настройки FFmpeg

| Ключ | Что делает | Где менять | Комментарий |
|------|-------------|------------|-------------|
| `binary` | Путь к исполняемому FFmpeg | Настройки → FFmpeg | Укажите абсолютный путь, если FFmpeg не в `PATH`. |
| `vcodec` | Видеокодек (`libx264`, `auto_hw`, `copy`) | Настройки → FFmpeg | При блюре значение `copy` автоматически заменяется на `libx264`. |
| `crf` | Качество `libx264` (0–51) | Настройки → FFmpeg | 18–20 для TikTok/YouTube, меньше — лучше качество, больше — меньше размер. |
| `preset` | Скорость кодирования `libx264` | Настройки → FFmpeg | `veryfast` компромисс, `slow` — лучше качество, но дольше. |
| `format` | Контейнер (`mp4`, `mov`, `webm`) | Настройки → FFmpeg | TikTok/YouTube предпочитают `mp4`. |
| `copy_audio` | Копировать аудио без перекодирования | Настройки → FFmpeg | При несовместимом исходнике приложение подскажет перекодировать в AAC. |
| `blur_threads` | Количество параллельных запусков FFmpeg | Настройки → FFmpeg | Учитывайте число ядер/ГПУ, чтобы не перегрузить систему. |
| `post_chain` | Дополнительные фильтры (noise, unsharp и т.п.) | Настройки → FFmpeg | Применяются после масок блюра. |
| `presets.*.zones` | Координаты прямоугольников для блюра | Настройки → FFmpeg → таблица/предпросмотр | Наглядный редактор с миниплеером и прямоугольником-затенением. |

## 6. Автопостинг

### YouTube
1. В Google Cloud Console создайте OAuth‑клиент «Desktop app» и скачайте `client_secret.json`.
2. Во вкладке Настройки → YouTube добавьте канал, укажите `client_secret.json` и опциональный `credentials.json` (для хранения refresh_token).
3. Настройте папку, интервал, лимит и поведение «черновик/расписание».
4. Во вкладке «YouTube» выберите канал, включите расписание, укажите дату и интервал — приложение рассчёт шаг и запомнит последнее время публикации.
5. После загрузки файлы перемещаются в `uploaded/`, статус фиксируется в истории и (при включённом Telegram) в уведомлении.

### TikTok
**Локальный запуск**
1. Экспортируйте cookies TikTok (например, через расширение EditThisCookie) и сохраните в JSON. В профиле укажите путь к файлу, часовой пояс (например, `Europe/Warsaw`), смещение по времени и шаблон подписи.
2. Во вкладке «TikTok» выберите профиль, папку с клипами, включите/выключите черновики и расписание. Кнопка «Показать очередь» обновит счётчик и подсказки.
3. «Запустить загрузку» запускает Playwright в фоновом процессе. Приложение сообщает об успехе, переносит файлы в архив `uploaded_tiktok` и обновляет статистику.

**GitHub Actions**
- В каталоге `.github/workflows` лежит пример `tiktok-upload.yml`. Он ожидает секрет `TIKTOK_COOKIES_JSON` (содержимое cookies) и входные параметры `profile`, `src_dir`, `limit`, `interval`, `publish_at`, `draft`.
- Перед запуском задеплойте `app_config.yaml` в репозиторий или храните его в Actions secret и генерируйте файл в шаге.
- Workflow выполняет `scripts/bootstrap.py`, разворачивает cookies в `auth/tiktok_cookies.json` и запускает `sora_suite/workers/tiktok/upload_queue.py`.
- Запустить его можно кнопкой «GitHub Actions» на вкладке TikTok — приложение вызывает `gh workflow run` с выбранными параметрами.

## 7. Telegram уведомления
1. Создайте бота у @BotFather и получите токен.
2. Выясните chat id (команда `/start`, затем посмотрите `https://api.telegram.org/bot<TOKEN>/getUpdates`).
3. В Настройки → Telegram включите переключатель, укажите токен и chat id, нажмите «Отправить тест».
4. Бот уведомляет о каждом шаге сценария, сохранении настроек, обслуживании каталогов, а также о запуске/завершении YouTube и TikTok.

## 8. Обслуживание и обновления
- Раздел «Обслуживание» позволяет задать срок хранения для RAW/BLURRED/MERGED и запустить очистку.
- Кнопка «Размеры папок» выводит объём каталогов в историю событий.
- «Проверка окружения» анализирует наличие FFmpeg, Chrome, профилей, Telegram и YouTube-credentials.
- **GitHub обновления**: кнопка «Проверить обновления» делает `git fetch` и показывает сколько коммитов локально/на сервере. «Обновить из GitHub» выполняет `git pull --ff-only`, после чего перезагружает списки каналов и профилей. Для консольного сценария можно использовать `scripts/self_update.py`.

## 9. Сборка standalone-версий

### Windows (EXE через PyInstaller)
```bash
python -m pip install pyinstaller
pyinstaller --noconfirm --clean --windowed \
  --name "SoraSuite" \
  --add-data "sora_suite/app_config.yaml;sora_suite" \
  sora_suite/app.py
```
Итоговый `dist/SoraSuite/SoraSuite.exe` можно заархивировать или упаковать через Inno Setup/NSIS.

### macOS (DMG)
```bash
python -m pip install pyinstaller create-dmg
pyinstaller --noconfirm --clean --windowed \
  --name "SoraSuite" \
  --add-data "sora_suite/app_config.yaml:sora_suite" \
  sora_suite/app.py

create-dmg \
  --overwrite \
  --volname "Sora Suite" \
  --app-drop-link 400 200 \
  "SoraSuite.dmg" \
  "dist/SoraSuite.app"
```
Для распространения подпишите и нотарифицируйте приложение (macOS 11+).

## 10. Параллельные окна Sora
1. Нажмите «Автонайти» — приложение просканирует стандартные директории профилей Chrome и создаст заготовки `prompts_<slug>.txt`.
2. Для каждого окна задайте уникальный порт (9222, 9223, …), при необходимости путь к `user_data_dir`.
3. Журналы отправок (`submitted_<имя>.log`) обновляются раздельно; список использованных промптов можно сузить или растянуть сплиттером.
4. Кнопка «Параллельный автоген» запускает Playwright для всех отмеченных окон, прогресс отображается в карточке «Сейчас» и в Telegram.

## 11. Полезные подсказки
- Лента событий имеет два режима плотности и полностью сворачивается.
- «Сейчас» показывает длительность текущего шага; таймер автоматически сбрасывается при завершении.
- История и список использованных промптов можно масштабировать сплиттерами.
- Скрипт `scripts/bootstrap.py` удобно запускать после обновления репозитория или на CI.
- GitHub workflow `tiktok-upload.yml` служит шаблоном для автономного постинга без выделенного сервера.

Sora Suite продолжает развиваться: добавляйте собственные воркеры в `sora_suite/workers/` и подключайте их во вкладке «Задачи». Архитектура уже разделяет этапы на независимые блоки и позволяет быстро расширять пайплайн.
