# Sora Suite — контрольный центр для пайплайна Sora

Sora Suite объединяет в одном PyQt6‑GUI все этапы типичного рабочего цикла вокруг Sora:

* подача промптов (в один поток или параллельно в несколько окон);
* скачивание черновиков, блюр водяных знаков, склейка и переименование;
* планирование отложенных публикаций на YouTube для нескольких каналов;
* управление пресетами FFmpeg и предпросмотром зон блюра;
* уведомления в Telegram и журналы событий прямо в приложении;
* обслуживание каталогов и экспресс‑проверка окружения.

## Установка и зависимости

> Все команды выполняются из каталога `sora_suite/`.

### Общие шаги

```bash
python -m venv .venv
# Windows: .venv\Scripts\activate
# macOS/Linux: source .venv/bin/activate
pip install -r requirements.txt
python -m playwright install chromium
```

FFmpeg должен быть в `PATH`. На Windows удобно ставить сборку с [gyan.dev](https://www.gyan.dev/ffmpeg/builds/), на macOS — `brew install ffmpeg`, на Debian/Ubuntu — `sudo apt install ffmpeg`.

### Windows
1. Используйте PowerShell (x64) или Developer Command Prompt.
2. Если pip просит собрать `opencv-python`, выполните:
   ```powershell
   python -m pip install --upgrade pip setuptools wheel
   pip install --upgrade --force-reinstall opencv-python
   ```

### macOS (Apple Silicon)
1. Запускайте arm64‑Python (`which python` должен указывать на arm64).
2. При необходимости установите OpenCV командой `arch -arm64 python3 -m pip install opencv-python`.

### Linux
1. Для Playwright потребуются `libnss3`, `libxss1`, `fonts-liberation` (в Ubuntu: `sudo apt install libnss3 libxss1 fonts-liberation`).
2. Убедитесь, что системный FFmpeg установлен (`sudo apt install ffmpeg`).

Проверка мультимедиа:
```bash
python -c "import cv2; print('OpenCV', cv2.__version__)"
ffmpeg -version
```

## Запуск

```bash
python app.py
```

В верхней панели находятся кнопки открытия папок и пара `Старт выбранного` / `Стоп все`. Первая мгновенно запускает сценарий, собранный галочками во вкладке «Задачи».

## Обзор интерфейса

### «Задачи»
* описание вверху напоминает, что нужно отметить шаги и нажать старт;
* подтаб «Пайплайн» содержит чекбоксы автогена, скачки, блюра, склейки и YouTube;
* счётчики RAW / BLURRED / MERGED / UPLOAD теперь снабжены подписями и подсказками;
* другие подтабы («Скачка», «Переименование», «Склейка») дают отдельные пояснения и компактные формы.

### «Промпты»
* слева — список профилей Chrome; активный подсвечен строкой «Сценарий использует …»;
* каждому профилю соответствует собственный файл `prompts_<slug>.txt`, создающийся автоматически;
* редактор справа использует фиксированный шрифт, кнопки «Обновить файл», «Сохранить изменения», «Сохранить и запустить автоген»;
* таблица «Использованные промпты» показывает историю с датой, окном и текстом;
* ниже расположен менеджер параллельных окон Sora (порт, профиль, пользовательские файлы). Кнопка «Автонайти» сканирует стандартные каталоги профилей на Windows/macOS/Linux.

### «Названия»
Короткое описание подсказывает, что каждое имя — отдельная строка. Есть кнопки загрузки, сохранения и сброса курсора переименования.

### «Настройки»
* **Каталоги** — уменьшенные интервалы между полями; источники блюра/склейки/YouTube следуют за базовыми папками, пока вы не зададите собственный путь.
* **Chrome** — порт CDP, бинарник, user-data, список профилей.
* **FFmpeg** — параметры кодека, таблица зон, кнопка предпросмотра на OpenCV.
* **YouTube** — каналы, OAuth, расписание публикаций (дата старта, интервал, лимит, черновики).
* **Telegram** — токен, chat id, переключатель и тестовая отправка.
* **Обслуживание** — сроки хранения, моментальная очистка, отчёт о размерах, проверка окружения.
* **Документация** — встроенный просмотр README с кнопкой «Обновить».

Все изменения автосохраняются через 2 секунды, но есть кнопка «Применить настройки».

### «YouTube» (основная вкладка)
Даёт быстрый доступ к очереди роликов, настройкам отложенного постинга и управлению каналом.

### «Ошибки»
Справочник по типовым ситуациям: таймауты, отказ очереди, проблемы FFmpeg/YouTube/Playwright, а также рекомендации по устранению.

## Chrome‑профили и параллельные окна

Перед первым запуском приложение автоматически сканирует стандартные каталоги Chrome и заполняет список профилей. Файлы `prompts_<slug>.txt` для каждого профиля создаются на лету, поэтому тексты не перемешиваются между окнами.

1. Откройте блок «Окна Sora и параллельная подача».
2. При необходимости нажмите «Автонайти» — повторный поиск ищет новые профили Chrome на Windows, macOS и Linux.
3. Выберите профиль для инстанса — поля `user_data_dir`/`profile_directory` и файл `prompts_<slug>.txt` заполнятся автоматически.
4. Задавайте уникальные порты (9222, 9223, 9224 …). Кнопка «Запустить окна Chrome» поднимет нужные профили одновременно.
5. «Параллельный автоген» запускает отдельный Playwright-процесс для каждого отмеченного окна; статусы выводятся в карточку «Сейчас» и (если включено) в Telegram.

Журнал отправленных строк (`submitted_<имя>.log`) остаётся индивидуальным для каждого окна.

## Таблица настроек FFmpeg

| Настройка | Назначение | Где менять |
|-----------|------------|------------|
| `binary` | путь к исполняемому FFmpeg | Настройки → FFmpeg → поле «FFmpeg binary» |
| `vcodec` | выбранный видеокодек (`libx264`, `h264_nvenc`, `auto_hw`) | Настройки → FFmpeg |
| `crf` | качество `libx264` (ниже значение — лучше картинка, больше размер) | Настройки → FFmpeg |
| `preset` | баланс скорость/качество для `libx264` | Настройки → FFmpeg |
| `format` | контейнер выходного файла (`mp4`, `mov`, …) | Настройки → FFmpeg |
| `copy_audio` | оставить ли оригинальную аудиодорожку | Настройки → FFmpeg |
| `blur_threads` | число параллельных запусков FFmpeg | Настройки → FFmpeg |
| `post_chain` | дополнительная цепочка фильтров (шумоподавление, резкость) | Настройки → FFmpeg |
| `presets.*.zones` | координаты прямоугольников для блюра | Настройки → FFmpeg → таблица/предпросмотр |

## Загрузка на YouTube

1. В [Google Cloud Console](https://console.cloud.google.com/) создайте OAuth‑клиент типа **Desktop** и скачайте `client_secret.json`.
2. Во вкладке **Настройки → YouTube** добавьте канал: укажите имя, путь к `client_secret.json`, место сохранения `credentials.json` (можно оставить пустым) и приватность по умолчанию.
3. Установите папку с клипами (по умолчанию `merged`), интервал между публикациями и максимальное количество роликов за запуск.
4. При первом старте загрузчика откроется браузер Playwright: авторизуйтесь и подтвердите доступ. Токен сохранится в `credentials.json`, что позволяет работать с несколькими каналами/пользователями.
5. Файлы после успешной загрузки перемещаются в архив `uploaded/`; статус отражается в панели событий и, при включённом Telegram, в уведомлении.

## Telegram‑уведомления

1. Создайте бота через @BotFather и получите токен.
2. Узнайте `chat_id` (команда `/start` и запрос `https://api.telegram.org/bot<TOKEN>/getUpdates`).
3. Введите данные во вкладке Настройки → Telegram, включите переключатель и отправьте тест.
4. После этого бот сообщит о старте/завершении каждого шага: автоген, скачка, блюр, склейка, переименование, YouTube, сохранение настроек, обслуживание каталогов.

## Сборка standalone‑версий

### Windows (PyInstaller → EXE)
```bash
python -m pip install pyinstaller
pyinstaller --noconfirm --clean --windowed \
  --name "SoraSuite" \
  --add-data "sora_suite/app_config.yaml;sora_suite" \
  sora_suite/app.py
```
Готовый `dist/SoraSuite/SoraSuite.exe` можно распространять как zip или упаковать через Inno Setup/NSIS.

### macOS (PyInstaller + create-dmg)
```bash
python -m pip install pyinstaller create-dmg
pyinstaller --noconfirm --clean --windowed \
  --name "SoraSuite" \
  --add-data "sora_suite/app_config.yaml:sora_suite" \
  sora_suite/app.py

create-dmg \
  --overwrite \
  --volname "Sora Suite" \
  --app-drop-link 400 200 \
  "SoraSuite.dmg" \
  "dist/SoraSuite.app"
```
DMG готов к распространению; для macOS 11+ при необходимости подпишите и нотарифицируйте приложение.

## Полезные подсказки

* **Проверка окружения** (Настройки → Обслуживание) проверяет наличие FFmpeg, Chrome, активного профиля, Telegram и YouTube‑кредов и отправляет сводку в панель событий/Telegram.
* **История событий** можно скрывать переключателем «Показывать». Есть компактный и стандартный режим отображения.
* **Счётчики RAW/BLURRED/MERGED/UPLOAD** снабжены подсказками о том, что именно считается.
* **Старт работы**: после первичного запуска нажмите «Автонайти» в блоке инстансов — это создаст файлы `prompts_<slug>.txt` и `submitted_<имя>.log` для каждого профиля.

Sora Suite рассчитана на поэтапное расширение. Если появятся новые шаги (например, дополнительные постпроцессы или другие платформы), добавьте воркеры в `workers/` и свяжите их с GUI — архитектура уже разделяет задачи на независимые блоки.
